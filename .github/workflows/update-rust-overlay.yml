name: Update rust-overlay

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 12 * * 0"
jobs:
  update-rust-overlay:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2.3.5
      - uses: cachix/install-nix-action@v16
        with:
          install_url: https://releases.nixos.org/nix/nix-2.5.1/install
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Update rust-overlay
        run: |
          nix flake lock --update-input rust-overlay
          sed -i "s/nightlyVersion = .\+;/nightlyVersion = \"$(nix eval .#rust-bin.nightly.latest._manifest.date | jq -r)\";/" templates/rust/flake.nix

      - name: Check updated flake
        run: |
          nix flake check
          cd templates/rust; nix flake check --override-input mars-std "path:$PWD/../.."

      - name: Commit changes
        id: commit
        continue-on-error: true
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "github-actions[bot]"
          git add flake.lock templates/rust/flake.nix
          git commit -m "Update rust-overlay"
          git --no-pager show

      - name: Push changes
        if: steps.commit.outcome == 'success'
        uses: ad-m/github-push-action@master
